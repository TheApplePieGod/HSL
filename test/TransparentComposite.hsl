#version 460

#include "FrameBuffer.hsl"

in vec2 texCoord;

out vec4 outHDRColor;
out vec4 outBrightColor;

uniform subpassTex<1, 0> texColor;
uniform subpassTex<2, 1> texWeights;

void main() {
    vec4 accum = subpassRead(texColor, hl_PixelPosition.xy / frameBuffer.data.screenSize);
    float reveal = subpassRead(texWeights, hl_PixelPosition.xy / frameBuffer.data.screenSize).r;

    // reversed because of blend
    if (reveal > 0.9999) { discard; }

    outHDRColor = vec4(accum.rgb / max(accum.a, 1e-5), reveal);
    float brightness = dot(outHDRColor.rgb, vec3(0.2126, 0.7152, 0.0722));
    if(brightness > frameBuffer.data.bloomThreshold)
    { outBrightColor = vec4(outHDRColor.rgb, 1.0); }
    else
    { outBrightColor = vec4(0.0, 0.0, 0.0, 1.0); }
}